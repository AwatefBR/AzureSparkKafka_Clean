name: CI - sbt assembly & Docker build

on:
  push:
    branches:
      - spark-clean-devops
  pull_request:
    branches:
      - spark-clean-devops

jobs:
  build-and-docker:
    runs-on: ubuntu-latest

    steps:
      # 1) R√©cup√©rer le code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2) sbt clean assembly dans un conteneur Docker
      - name: sbt clean assembly (via Docker)
        run: |
          docker run --rm \
            -v "$PWD:/app" \
            -w /app \
            sbtscala/scala-sbt:eclipse-temurin-17.0.4_1.7.1_3.2.0 \
            sbt clean assembly

      # 3) Build des images Docker avec docker compose
      - name: Docker compose build
        run: |
          docker compose build --no-cache || docker-compose build --no-cache

      # 4) Login to GitHub Container Registry
      - name: Login to GHCR
        if: github.event_name == 'push'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 5) Tag and push images to GHCR
      - name: Tag and push images
        if: github.event_name == 'push'
        run: |
          IMAGE_PREFIX="ghcr.io/${{ github.repository }}"
          TAG="${GITHUB_REF#refs/heads/}"
          TAG="${TAG//\//-}"
          
          # List all built images to find producer and consumer
          echo "üîç Listing built images..."
          docker images
          
          # Find producer image (from Dockerfile.main - used by producer-players and producer-scoreboard)
          PRODUCER_IMAGE=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep -E "producer-(players|scoreboard)" | head -1 | cut -d: -f1)
          
          # Find consumer image (from Dockerfile.consumer - used by spark-consumer-*)
          CONSUMER_IMAGE=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep -E "spark-consumer" | head -1 | cut -d: -f1)
          
          # Tag and push producer image
          if [ -n "$PRODUCER_IMAGE" ]; then
            echo "üì¶ Tagging and pushing producer image: ${PRODUCER_IMAGE}"
            docker tag ${PRODUCER_IMAGE}:latest ${IMAGE_PREFIX}/producer:${TAG}
            docker tag ${PRODUCER_IMAGE}:latest ${IMAGE_PREFIX}/producer:latest
            docker push ${IMAGE_PREFIX}/producer:${TAG}
            docker push ${IMAGE_PREFIX}/producer:latest
            echo "‚úÖ Pushed producer image"
          else
            echo "‚ö†Ô∏è Producer image not found"
          fi
          
          # Tag and push consumer image
          if [ -n "$CONSUMER_IMAGE" ]; then
            echo "üì¶ Tagging and pushing consumer image: ${CONSUMER_IMAGE}"
            docker tag ${CONSUMER_IMAGE}:latest ${IMAGE_PREFIX}/consumer:${TAG}
            docker tag ${CONSUMER_IMAGE}:latest ${IMAGE_PREFIX}/consumer:latest
            docker push ${IMAGE_PREFIX}/consumer:${TAG}
            docker push ${IMAGE_PREFIX}/consumer:latest
            echo "‚úÖ Pushed consumer image"
          else
            echo "‚ö†Ô∏è Consumer image not found"
          fi
