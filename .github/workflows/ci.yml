name: CI - sbt assembly & Docker build

on:
  push:
    branches:
<<<<<<< Updated upstream
      - main
=======
      - spark-clean-devops
      - main
  pull_request:
    branches:
      - spark-clean-devops
>>>>>>> Stashed changes

jobs:
  terraform-validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0

      - name: Terraform fmt + validate
        working-directory: infra
        run: |
          terraform fmt -check -recursive
          terraform init -backend=false
          terraform validate

  build-and-push:
    # üîë IMPORTANT : on ne pousse que sur push main (merge)
    if: github.event_name == 'push'
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
      # 1) Checkout
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2) sbt clean assembly (isol√©)
      - name: sbt clean assembly
        run: |
          docker run --rm \
            -v "$PWD:/app" \
            -w /app \
            sbtscala/scala-sbt:eclipse-temurin-17.0.4_1.7.1_3.2.0 \
            sbt clean assembly

      # 3) Docker build (compose)
      - name: Docker compose build
        run: docker compose build --no-cache

      # 4) Login GHCR
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 5) Tag & push images (LOWERCASE STRICT)
      - name: Tag and push images to GHCR
        run: |
          set -e

          OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          REPO=$(basename "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          TAG=main

          PRODUCER_IMAGE="ghcr.io/$OWNER/$REPO/producer"
          CONSUMER_IMAGE="ghcr.io/$OWNER/$REPO/consumer"

          echo "üì¶ Using images:"
          echo " - $PRODUCER_IMAGE:$TAG"
          echo " - $CONSUMER_IMAGE:$TAG"

          # üîç Debug images built
          docker images

          # Producer
          docker tag azuresparkkafka_clean-producer-players:latest $PRODUCER_IMAGE:$TAG
          docker tag azuresparkkafka_clean-producer-players:latest $PRODUCER_IMAGE:latest

          # Consumer
          docker tag azuresparkkafka_clean-spark-consumer-players:latest $CONSUMER_IMAGE:$TAG
          docker tag azuresparkkafka_clean-spark-consumer-players:latest $CONSUMER_IMAGE:latest

          # Push
          docker push $PRODUCER_IMAGE:$TAG
          docker push $PRODUCER_IMAGE:latest
          docker push $CONSUMER_IMAGE:$TAG
          docker push $CONSUMER_IMAGE:latest
          ls -lh target/scala-2.12

          echo "‚úÖ Images pushed successfully"
