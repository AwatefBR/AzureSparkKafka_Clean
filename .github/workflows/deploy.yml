name: Deploy to lol-vm

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "resume (restart only) or update (pull + sbt + build + up)"
        required: true
        default: "resume"
        type: choice
        options:
          - resume
          - update

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: SSH into VM and deploy
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            set -e
            cd /home/azureuser/lol-streaming-clean

            MODE="${{ github.event.inputs.mode }}"
            echo "üöÄ Deploy mode: $MODE"

            if [ "$MODE" = "update" ]; then
              # Check for uncommitted changes and handle them
              if ! git diff --quiet || ! git diff --cached --quiet; then
                echo "‚ö†Ô∏è Uncommitted changes detected. Stashing them..."
                git stash push -m "Auto-stash before deploy $(date +%Y%m%d_%H%M%S)" || true
              fi
              
              # Fetch and reset to match remote (discards local commits if any)
              echo "üì• Fetching latest changes..."
              git fetch origin spark-clean-devops
              git reset --hard origin/spark-clean-devops
              git clean -fd
              
              sbt clean assembly
              docker compose build || docker-compose build
              docker compose up -d || docker-compose up -d
            else
              docker compose up -d 
            fi

            docker compose ps