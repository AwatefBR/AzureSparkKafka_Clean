name: Deploy to lol-vm

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "resume (just restart) or update (pull+build+up)"
        required: true
        default: "resume"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: SSH into VM and deploy
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            set -e
            cd /home/azureuser/lol-streaming-clean

            MODE="${{ github.event.inputs.mode }}"
            echo "Deploy mode: $MODE"

            if [ "$MODE" = "update" ]; then
              git pull origin spark-clean-devops
              sbt clean assembly
              docker compose build || docker-compose build
              docker compose up -d || docker-compose up -d
            else
              # resume mode
              docker compose up -d || docker-compose up -d
            fi

            docker compose ps || docker-compose ps
