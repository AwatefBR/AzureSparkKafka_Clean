name: CD - Deploy to Production

on:
  workflow_run:
    workflows:
      - CI - sbt assembly & Docker build
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: read

    steps:
      - name: Deploy on VM via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          APP_TAG: main
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          PGADMIN_EMAIL: ${{ secrets.PGADMIN_EMAIL }}
          PGADMIN_PASSWORD: ${{ secrets.PGADMIN_PASSWORD }}
          KAFKA_BOOTSTRAP: ${{ secrets.KAFKA_BOOTSTRAP }}
          POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
          POSTGRES_PORT: ${{ secrets.POSTGRES_PORT }}
          AZURE_SQL_SERVER: ${{ secrets.AZURE_SQL_SERVER }}
          AZURE_SQL_DB: ${{ secrets.AZURE_SQL_DB }}
          AZURE_SQL_USER: ${{ secrets.AZURE_SQL_USER }}
          AZURE_SQL_PASSWORD: ${{ secrets.AZURE_SQL_PASSWORD }}
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          envs: GITHUB_REPOSITORY_OWNER,GITHUB_REPOSITORY,GITHUB_TOKEN,APP_TAG,POSTGRES_DB,POSTGRES_USER,POSTGRES_PASSWORD,PGADMIN_EMAIL,PGADMIN_PASSWORD,KAFKA_BOOTSTRAP,POSTGRES_HOST,POSTGRES_PORT,AZURE_SQL_SERVER,AZURE_SQL_DB,AZURE_SQL_USER,AZURE_SQL_PASSWORD
          script: |
            set -eo pipefail
            REPO_DIR="/home/azureuser/lol-streaming-clean"
            OWNER="$(echo "${GITHUB_REPOSITORY_OWNER:-${{ github.repository_owner }}}" | tr '[:upper:]' '[:lower:]')"
            REPO="$(basename "${GITHUB_REPOSITORY:-${{ github.repository }}}" | tr '[:upper:]' '[:lower:]')"

            cd "$REPO_DIR"

            if [ -f .env ]; then
              cp .env .env.bak
              echo ".env found, backup created: .env.bak"
            fi

            required_vars=(
              POSTGRES_DB POSTGRES_USER POSTGRES_PASSWORD
              PGADMIN_EMAIL PGADMIN_PASSWORD
              KAFKA_BOOTSTRAP POSTGRES_HOST POSTGRES_PORT
              AZURE_SQL_SERVER AZURE_SQL_DB AZURE_SQL_USER AZURE_SQL_PASSWORD
            )
            missing=0
            for v in "${required_vars[@]}"; do
              if [ -z "${!v:-}" ]; then
                echo "Missing required env var: $v"
                missing=1
              fi
            done
            if [ "$missing" -ne 0 ]; then
              echo "Aborting deploy due to missing secrets."
              exit 1
            fi

            cat > .env <<EOF
            OWNER=${OWNER}
            REPO=${REPO}
            POSTGRES_DB=${POSTGRES_DB}
            POSTGRES_USER=${POSTGRES_USER}
            POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
            PGADMIN_EMAIL=${PGADMIN_EMAIL}
            PGADMIN_PASSWORD=${PGADMIN_PASSWORD}
            KAFKA_BOOTSTRAP=${KAFKA_BOOTSTRAP}
            POSTGRES_HOST=${POSTGRES_HOST}
            POSTGRES_PORT=${POSTGRES_PORT}
            AZURE_SQL_SERVER=${AZURE_SQL_SERVER}
            AZURE_SQL_DB=${AZURE_SQL_DB}
            AZURE_SQL_USER=${AZURE_SQL_USER}
            AZURE_SQL_PASSWORD=${AZURE_SQL_PASSWORD}
            EOF

            echo "$GITHUB_TOKEN" | docker login ghcr.io -u "$OWNER" --password-stdin
            docker pull "ghcr.io/$OWNER/$REPO/producer:$APP_TAG"
            docker pull "ghcr.io/$OWNER/$REPO/consumer:$APP_TAG"

            docker compose -f docker-compose.prod.yml up -d --no-build
            docker compose -f docker-compose.prod.yml ps
